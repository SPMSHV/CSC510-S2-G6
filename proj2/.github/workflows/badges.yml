name: Update Badges

on:
  push:
    branches: [ main, MAIN ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-badges:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests with coverage
      id: tests
      run: |
        # Run tests with coverage and JSON output for reliable parsing
        npm run test:coverage -- --json --outputFile=test-results.json 2>&1 | tee test-output.txt || true
        
        # Extract test count from Jest JSON output (most reliable)
        if [ -f "test-results.json" ]; then
          TEST_COUNT=$(node -e "const data = require('./test-results.json'); console.log(data.numPassedTests || 0);" 2>/dev/null || echo "")
        fi
        
        # Fallback: Extract from text output if JSON parsing failed
        if [ -z "$TEST_COUNT" ] || [ "$TEST_COUNT" = "0" ] || [ "$TEST_COUNT" = "null" ]; then
          TEST_OUTPUT=$(cat test-output.txt)
          
          # Pattern 1: "Tests: X passed"
          TEST_COUNT=$(echo "$TEST_OUTPUT" | grep -oE 'Tests:\s+[0-9]+\s+passed' | grep -oE '[0-9]+' | head -1 || echo "")
          
          # Pattern 2: "X passed" (standalone)
          if [ -z "$TEST_COUNT" ]; then
            TEST_COUNT=$(echo "$TEST_OUTPUT" | grep -oE '([0-9]+)\s+passed' | grep -oE '[0-9]+' | head -1 || echo "")
          fi
          
          # Pattern 3: Jest summary format
          if [ -z "$TEST_COUNT" ]; then
            TEST_COUNT=$(echo "$TEST_OUTPUT" | grep -oE 'Test Suites:.*([0-9]+)\s+passed' | grep -oE '[0-9]+' | head -1 || echo "")
          fi
          
          # Pattern 4: Look for "PASS" line
          if [ -z "$TEST_COUNT" ]; then
            TEST_COUNT=$(echo "$TEST_OUTPUT" | grep -oE 'PASS.*[0-9]+\s+passed' | grep -oE '[0-9]+' | head -1 || echo "")
          fi
        fi
        
        # Ensure we have a valid number
        if [ -z "$TEST_COUNT" ] || [ "$TEST_COUNT" = "0" ] || [ "$TEST_COUNT" = "null" ]; then
          TEST_COUNT="0"
        fi
        
        echo "test_count=$TEST_COUNT" >> $GITHUB_OUTPUT
        
        # Get workflow run URL for linking
        WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "workflow_url=$WORKFLOW_RUN_URL" >> $GITHUB_OUTPUT
        
        # Debug output
        echo "Extracted test count: $TEST_COUNT"
        if [ -f "test-results.json" ]; then
          echo "Test results summary:"
          node -e "const data = require('./test-results.json'); console.log('Total:', data.numTotalTests, 'Passed:', data.numPassedTests, 'Failed:', data.numFailedTests);" 2>/dev/null || true
        fi

    - name: Calculate coverage percentage
      id: coverage
      run: |
        if [ -f "coverage/lcov.info" ]; then
          # Parse lcov.info to calculate overall coverage
          # Sum up LF (lines found) and LH (lines hit) across all files
          TOTAL_LF=0
          TOTAL_LH=0
          
          while IFS= read -r line; do
            if [[ $line == LF:* ]]; then
              LF=$(echo "$line" | grep -oE '[0-9]+' | head -1)
              TOTAL_LF=$((TOTAL_LF + LF))
            elif [[ $line == LH:* ]]; then
              LH=$(echo "$line" | grep -oE '[0-9]+' | head -1)
              TOTAL_LH=$((TOTAL_LH + LH))
            fi
          done < coverage/lcov.info
          
          if [ $TOTAL_LF -gt 0 ]; then
            COVERAGE_PERCENT=$(awk "BEGIN {printf \"%.0f\", ($TOTAL_LH / $TOTAL_LF) * 100}")
          else
            COVERAGE_PERCENT=0
          fi
        else
          COVERAGE_PERCENT=0
        fi
        
        echo "coverage_percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
        
        # Determine badge color based on coverage
        if [ $COVERAGE_PERCENT -ge 80 ]; then
          COVERAGE_COLOR="brightgreen"
        elif [ $COVERAGE_PERCENT -ge 60 ]; then
          COVERAGE_COLOR="green"
        elif [ $COVERAGE_PERCENT -ge 40 ]; then
          COVERAGE_COLOR="yellow"
        else
          COVERAGE_COLOR="red"
        fi
        echo "coverage_color=$COVERAGE_COLOR" >> $GITHUB_OUTPUT

    - name: Generate badge URLs
      id: badges
      run: |
        TEST_COUNT="${{ steps.tests.outputs.test_count }}"
        COVERAGE_PERCENT="${{ steps.coverage.outputs.coverage_percent }}"
        COVERAGE_COLOR="${{ steps.coverage.outputs.coverage_color }}"
        WORKFLOW_URL="${{ steps.tests.outputs.workflow_url }}"
        
        # Generate test badge URL
        TEST_BADGE_URL="https://img.shields.io/badge/tests-${TEST_COUNT}%20passing-success"
        
        # Generate coverage badge URL
        COVERAGE_BADGE_URL="https://img.shields.io/badge/coverage-${COVERAGE_PERCENT}%25-${COVERAGE_COLOR}"
        
        echo "test_badge_url=$TEST_BADGE_URL" >> $GITHUB_OUTPUT
        echo "coverage_badge_url=$COVERAGE_BADGE_URL" >> $GITHUB_OUTPUT
        echo "test_link=$WORKFLOW_URL" >> $GITHUB_OUTPUT
        echo "coverage_link=$WORKFLOW_URL" >> $GITHUB_OUTPUT

    - name: Update README badges
      run: |
        node << 'EOF'
        const fs = require('fs');
        const readme = fs.readFileSync('README.md', 'utf8');
        
        const testBadgeUrl = process.env.TEST_BADGE_URL;
        const coverageBadgeUrl = process.env.COVERAGE_BADGE_URL;
        const testLink = process.env.TEST_LINK;
        const coverageLink = process.env.COVERAGE_LINK;
        
        // Update test badge - match the pattern [![Tests](...)](...)
        let updated = readme.replace(
          /\[!\[Tests\]\([^)]+\)\]\([^)]+\)/,
          `[![Tests](${testBadgeUrl})](${testLink})`
        );
        
        // Update coverage badge - match the pattern [![Coverage](...)](...)
        updated = updated.replace(
          /\[!\[Coverage\]\([^)]+\)\]\([^)]+\)/,
          `[![Coverage](${coverageBadgeUrl})](${coverageLink})`
        );
        
        fs.writeFileSync('README.md', updated);
        console.log('Updated README badges');
        console.log('Test badge:', testBadgeUrl);
        console.log('Coverage badge:', coverageBadgeUrl);
        EOF
      env:
        TEST_BADGE_URL: ${{ steps.badges.outputs.test_badge_url }}
        COVERAGE_BADGE_URL: ${{ steps.badges.outputs.coverage_badge_url }}
        TEST_LINK: ${{ steps.badges.outputs.test_link }}
        COVERAGE_LINK: ${{ steps.badges.outputs.coverage_link }}

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "No changes to README badges, skipping commit"
        else
          git commit -m "Update badges: ${{ steps.tests.outputs.test_count }} tests passing, ${{ steps.coverage.outputs.coverage_percent }}% coverage [skip ci]"
          git push
        fi

